<html>

<head>
<style>
/* Create two equal columns that floats next to each other */
.column {
  float: left;
  width: 50%;
}
</style>
</head>

<script src='https://d3js.org/d3.v5.min.js'></script>

<body onload='init_all()'>

<h2>MPG</h2>
<p>Analyses of Car Fuel Consumption</p>

<div id="mpg_tab">
  <input type="radio" name="mpg_type" value="displacement" onclick="refresh_mpg()" checked> <b>MPG by Displacement</b>
  <input type="radio" name="mpg_type" value="power" onclick="refresh_mpg()"> <b>MPG by Power</b>
  <input type="radio" name="mpg_type" value="weight" onclick="refresh_mpg()"> <b>MPG by Weight</b>
  <input type="radio" name="mpg_type" value="model_year" onclick="refresh_mpg()"> <b>MPG by Model Year</b>
</div>

<div>
  Number of Cylinders: 
  <input type="checkbox" onclick="click_cylinders(this, 4);" checked>4
  <input type="checkbox" onclick="click_cylinders(this, 6);" checked>6
  <input type="checkbox" onclick="click_cylinders(this, 8);" checked>8
</div>

<div id="div_summary"></div>

<div class="row">
  <div id="div_mpg" class="column"></div>
  <div id="div_details" class="column"></div>
</div>

<script>

var summary_width=600, summary_height=200, summary_margin=50;
var mpg_width=600, mpg_height=500, mpg_margin=80;
var details_width=200, details_height=500, mpg_margin=80;
var data;
var tab = "displacement";
var cylinders_selected = [true,true,true,true,true,true,true,true,true,true,true,true];

function click_cylinders(cb, cylinders) {
  cylinders_selected[cylinders] = cb.checked;
  refresh_mpg();
}

async function refresh_mpg() {
  switch (d3.select('input[name="mpg_type"]:checked').node().value) {
  case "displacement":
    await paint_mpg_by_displacement();
    break;
  case "weight":
    await paint_mpg_by_weight();
    break;
  case "power":
    await paint_mpg_by_power();
    break;
  case "model_year":
    await paint_mpg_by_model_year();
    break;
  }
}

function clear_mpg() {
  d3.select('#div_mpg').selectAll('*').remove();
}

async function init_all() {
  data = await d3.csv('https://danqian1296.github.io/DV/auto-mpg.csv');
  await paint_mpg_by_displacement();
}

async function paint_mpg_by_displacement() {
  clear_mpg();
  update_summary('TODO: some analysis for displacement');

  xscale = d3.scaleLinear().domain([0, 600]).range([0, mpg_width - mpg_margin * 2]);
  await paint_mpg(
    xscale,
    function(d,i) {return xscale(Number(d.displacement));},
    "Displacement (cubic inches)"
  );
}

async function paint_mpg_by_power() {
  clear_mpg();
  update_summary('TODO: some analysis for power');

  xscale = d3.scaleLinear().domain([0, 250]).range([0, mpg_width - mpg_margin * 2]);
  await paint_mpg(
    xscale,
    function(d,i) {return xscale(Number(d.horsepower));},
    "Power (horsepower)"
  );
}

async function paint_mpg_by_weight() {
  clear_mpg();
  update_summary('TODO: some analysis for weight');

  xscale = d3.scaleLinear().domain([1000, 6000]).range([0, mpg_width - mpg_margin * 2]);
  await paint_mpg(
    xscale,
    function(d,i) {return xscale(Number(d.weight));},
    "Weight (pounds)"
  );
}

async function paint_mpg_by_model_year() {
  clear_mpg();
  update_summary('TODO: some analysis for model year');

  xscale = d3.scaleLinear().domain([70, 85]).range([0, mpg_width - mpg_margin * 2]);
  await paint_mpg(
    xscale,
    function(d,i) {return xscale(Number(d.model_year));},
    "Model Year"
  );
}

function update_summary(summary_text) {
  d3.select("#div_summary").selectAll('*').remove();
  d3.select('#div_summary')
    .append('svg')
    .attr('width', summary_width)
    .attr('height', summary_height);

  d3.select('#div_summary').select('svg')
    .append("foreignObject")
      .attr("width", summary_width - summary_margin * 2)
      .attr("height", summary_height - summary_margin * 2)
      .attr("transform", 'translate(' + summary_margin + ', ' + summary_margin + ')')
      .append("xhtml:div")
      .html(summary_text);
}

function update_details(d, i) {
  d3.select("#div_details").selectAll('*').remove();
  d3.select('#div_details')
    .append('svg')
    .attr('width', details_width)
    .attr('height', details_height);

  d3.select('#div_details').select('svg')
    .append("foreignObject")
      .attr("width", details_width - summary_margin)
      .attr("height", details_height - summary_margin)
      .attr("transform", 'translate(' + summary_margin + ', ' + summary_margin + ')')
      .append("xhtml:div")
      .html(d.car_name);
}

function clear_details(d, i) {
  d3.select("#div_details").selectAll('*').remove();
}

function is_car_selected(car_data) {
  if (!cylinders_selected[car_data.cylinders]) return false;
  return true;
}

async function paint_mpg(xscale, xfunc, xtext) {
  // Create the MPG graph
  d3.select('#div_mpg')
    .append('svg')
    .attr('width', mpg_width)
    .attr('height', mpg_height);

  yscale = d3.scaleLinear().domain([0, 60]).range([mpg_height - mpg_margin * 2, 0]);

  // Plot the data
  d3.select('#div_mpg').select('svg')
    .append('g')
      .attr('transform', 'translate(' + mpg_margin + ',' + mpg_margin + ')')
    .selectAll()
    .data(data)
    .enter()
      .append('circle')
      .attr('stroke', 'grey')
      .attr('fill-opacity', '50%')
      .attr('fill', function(d) {return is_car_selected(d) ? "green" : "grey";} )
      .attr('cx', xfunc)
      .attr('cy', function(d,i) {return yscale(Number(d.mpg));})
      .attr('r', function(d,i) {return Number(d.cylinders);})
      .on('mouseover', update_details)
      .on('mouseout', clear_details);


  // Y-axis (mpg)
  d3.select('#div_mpg').select('svg')
    .append('g')
      .attr('transform', 'translate(' + mpg_margin + ', ' + mpg_margin + ')') 
      .call(d3.axisLeft(yscale)
        .tickValues([0,20,40,60]).tickFormat(d3.format("~s")));

  d3.select('#div_mpg').select('svg')
    .append("text")
      .attr('transform', 'translate(' + (mpg_margin / 2) + ', ' + (mpg_height / 2) + ')')
      .style("text-anchor", "middle")
      .text("MPG");    

  // X-axis
  d3.select('#div_mpg').select('svg')
    .append('g')
      .attr('transform', 'translate(' + mpg_margin + ', ' + (mpg_height - mpg_margin) + ')') 
      .call(d3.axisBottom(xscale)
        .ticks(4));

  d3.select('#div_mpg').select('svg')
    .append("text")             
      .attr("transform", 'translate(' + (mpg_width / 2) + ', ' + (mpg_height - mpg_margin / 2)+ ')')
      .style("text-anchor", "middle")
      .text(xtext);
}

</script>

</body>
</html>

